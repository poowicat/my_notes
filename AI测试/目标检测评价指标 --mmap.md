# 目标检测

## 概念

- **输入**  图片
- **输出**  图像中所存在的目标，**类别**（是什么？label）、**位置信息**（在哪里？bounding box）

## 特点  

- 非结构化 很强不确定性。

## 与分类对比 

- 例子：图像分类 结构化
- 输入 图像
- 输出 标签/类别
- 因此分类任务的输出是结构化的，有且仅有一个标签
- 而目标检测的输出是图像中所有目标（类别+位置）
- 重要：图像中有多少个目标是不确定的
- 结论：目标检测的性能度量方法 比 图像分类要复杂得多

## 检测结果“好坏”衡量：

- 肉眼很容易对比真实目标与检测结果的“贴合程度”
- 但 计算机视觉中需要明确的数字化判断标准
  - GT（类别，矩形）表示真值
  - DT（类别，矩形）表示检测出来的目标
  - 一个好的检测结果需要：
    1. 类别搞对：GT（类别）== DT（类别）
    2. 尽可能贴合：IOU

![preview](https://pic3.zhimg.com/v2-5b521592a307eed41bccb78b9c99501e_r.jpg)

## 评价性能前提

1. 图像分类
   - 看预测类别是否正确即可
   - 在一个数据集上很容易得到平均准确率
2. 目标检测
   - 由于 输出目标数量和真实目标数量不对应（非结构化特性）
   - 评判时 考虑不仅仅是对错
   - 需考虑：
     1. 如果漏掉一个目标对性能多大损伤？
     2. 多检测一个目标对性能多大损伤？
     3. 检测出来位置信息有所偏差对性能有多大损伤？
     4. 检测结果多。有些检测器十分笃定，有些模棱两可。
     5. 若检测器对多检测出来的目标本身也不太确定呢？
     6. 如果检测器最满意最信任的那个检测结果出错？
     7. 换言之：一个检测结果对新能的影响，是否应该和检测器对它的满意程度（置信度）相关？以及，检测错了一个稀有的物体和检测错了一个常见物体所带来的性能损伤是否应该相同呢？

## mmAP

### 概念：

mmAP先按位置准确度的需求进行划分，设置一组IOU阈值，这组阈值为 (0.5, 0.55, 0.6, ..., 0.9, 0.95),如果DT与GT的IOU超过阈值，则视作检测成功。然后这些性能取**平均**就是mmAP，就是整个检测算法的性能。

###  类别平衡

“将一个白血病患者错分为健康的人”

“将一个健康的人错分为白血病患者”

以上两者显然不一样。因为健康人数>>患病人数，即这个分类器正确率很高，但失去了判断病患功能。

## mmAP采用了类别间求平均方法：

1. 给定IOU阈值 (0.5, 0.55, 0.6, ..., 0.9, 0.95)，,如果DT与GT的IOU超过阈值，则视作检测成功。
2. 每给定一个阈值可以计算一个性能（map），这些性能取平均也就是mmap，即是整个检测算法的性能了。
3. 给定一个IOU阈值，给定一个类别
   1. 对所有检测结果排序，得分越高越靠前
   2. 依次判断是否检测成功
   3. 将排序后的所有结果定义为DTs，所有同类别的真实目标定义为GTs。
   4. 依次遍历一遍DTs中所有DT
   5. 每个DT和全部GT都计算一个IOU，若IOU>阈值====>检测成功计为TP，反之为FP。
   6. 每当一个GT被检测成功后，都会从GTs中“被取走”（防止后续检测结果重复匹配）
   7. 若有多个检测结果都与同一个GT匹配，即分数最高的那个会被算作TP，其余均为FP
   8. 遍历完成后，就知道了所有DTs中，那些是TP，那些是FP，由于被匹配过的GT都会被“取走”，因此GTs中剩下的就是没有被匹配上的FN

## TP,FP,FN

- 有了TP、FP、FN的定义，就可以方便地得出
- 准确率（Precison，P，即所有的检测结果中多少是对的）
- 召回率（Recall，R，即所有的真实目标中有多少被检测出来了）

- 两者的定义分别为：P = TP / (TP + FP), R = TP / (TP + FN) = TP / len(GTs)。![img](https://i.loli.net/2021/09/16/J2aGICA3qEMipNZ.png)

## 单纯用P/R评价整个检测不公平

- 有的要求更高的Recall，“错检”几个影响不大。
- 有的要求更高的Precision，“漏检”几个影响不大。

### 对P、R整体评估AP（Average Precision）

#### 定义：

- 对排序好的det结果进行“截取”

- 依次观察det结果的前1个、前2个、...、前N个

- 每次观察都能得到一个对应的P和R

- 随着观察数量的增大，R一定或变大或者不变

- 因此可以R为横轴，P为纵轴，将每次截取观察到的P和R画一个坐标点（R，P）

- 注意：当“截取“到的新结果为FP（测错）时，因为R没有变化所以并不会有新的（R，P）点产生。

- 最后利用这些（R，P）点绘制P-R曲线

- 定义

  ![[公式]](https://www.zhihu.com/equation?tex=AP+%3D+\int_{0}^{1}PdR)

#### 总结：

- AP的计算综合性地评价了检测器，并不会对P和R有任何“偏好”，
- 同时，检测分数越高的结果对AP的影响越大，分数越低的对AP的影响越小。



